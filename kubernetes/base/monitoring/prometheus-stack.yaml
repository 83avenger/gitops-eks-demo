# kube-prometheus-stack via Helm chart in ArgoCD
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus-stack
  namespace: argocd
spec:
  project: platform
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: "61.7.2"
    helm:
      releaseName: prometheus-stack
      valuesObject:
        grafana:
          enabled: true
          adminPassword: ""   # Set via ExternalSecret
          ingress:
            enabled: true
            hosts:
              - grafana.dev.example.com
          dashboardProviders:
            dashboardproviders.yaml:
              apiVersion: 1
              providers:
                - name: default
                  orgId: 1
                  folder: ''
                  type: file
                  options:
                    path: /var/lib/grafana/dashboards/default
          dashboards:
            default:
              kubernetes-cluster:
                gnetId: 7249
                revision: 1
                datasource: Prometheus
              argocd:
                gnetId: 14584
                revision: 1
                datasource: Prometheus

        prometheus:
          prometheusSpec:
            retention: 15d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 50Gi
            # Scrape all ServiceMonitors across all namespaces
            serviceMonitorSelectorNilUsesHelmValues: false
            podMonitorSelectorNilUsesHelmValues: false
            ruleSelectorNilUsesHelmValues: false

        alertmanager:
          alertmanagerSpec:
            replicas: 2
          config:
            global:
              slack_api_url: ""  # Set via ExternalSecret
            route:
              group_by: ['alertname', 'namespace']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 12h
              receiver: 'slack-warnings'
              routes:
                - matchers:
                    - name: severity
                      value: critical
                  receiver: 'pagerduty-critical'
                - matchers:
                    - name: severity
                      value: warning
                  receiver: 'slack-warnings'
            receivers:
              - name: 'slack-warnings'
                slack_configs:
                  - channel: '#alerts-dev'
                    send_resolved: true
                    title: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}'
                    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
              - name: 'pagerduty-critical'
                pagerduty_configs:
                  - service_key: ""  # Set via ExternalSecret

        kubeStateMetrics:
          enabled: true

        nodeExporter:
          enabled: true

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
